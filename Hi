local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- State
local isRunning = false

-- Helpers
local function getHumAndRoot(character)
    if not character then return nil, nil end
    local hum = character:FindFirstChildOfClass("Humanoid")
    local root = character:FindFirstChild("HumanoidRootPart")
    return hum, root
end

local function getHead(character)
    return character and character:FindFirstChild("Head")
end

local function GetPlayerByName(name)
    if not name or name == "" then return nil, false end
    name = name:lower()
    if name == "all" or name == "others" then
        return nil, true
    elseif name == "random" then
        local list = Players:GetPlayers()
        for i = #list, 1, -1 do
            if list[i] == LocalPlayer then table.remove(list, i) end
        end
        if #list == 0 then return nil, false end
        return list[math.random(#list)], false
    end
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            if plr.Name:lower():match("^" .. name) or plr.DisplayName:lower():match("^" .. name) then
                return plr, false
            end
        end
    end
    return nil, false
end

-- Improved fling (returns to original position after fling)
local function SkidFling(TargetPlayer)
    if not TargetPlayer then return end
    local char = LocalPlayer.Character
    if not char then return end
    local hum, hrp = getHumAndRoot(char)
    if not (hum and hrp) then return end

    local TChar = TargetPlayer.Character
    if not TChar then return end
    local TRoot = TChar:FindFirstChild("HumanoidRootPart") or getHead(TChar)
    if not TRoot then return end

    -- Save current position
    local originalCFrame = hrp.CFrame

    -- Apply fling
    local bv = Instance.new("BodyVelocity")
    bv.Velocity = Vector3.new(1e9, 1e9, 1e9)
    bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    bv.Parent = hrp

    hrp.CFrame = TRoot.CFrame
    task.wait(0.5)

    -- Cleanup + teleport back
    bv:Destroy()
    hrp.CFrame = originalCFrame
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FlingGUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = LocalPlayer:FindFirstChild("PlayerGui") or CoreGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 100)
frame.Position = UDim2.new(0, 20, 0, 20)
frame.BackgroundTransparency = 0.25
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.Parent = screenGui

-- Dragging
local dragging, dragInput, dragStart, startPos
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                   startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- UI Elements
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -10, 0, 20)
title.Position = UDim2.new(0, 5, 0, 5)
title.BackgroundTransparency = 1
title.Text = "Fling GUI"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.Parent = frame

local userBox = Instance.new("TextBox")
userBox.Size = UDim2.new(1, -10, 0, 26)
userBox.Position = UDim2.new(0, 5, 0, 30)
userBox.PlaceholderText = "Enter username / all / others / random"
userBox.ClearTextOnFocus = false
userBox.Font = Enum.Font.SourceSans
userBox.TextSize = 14
userBox.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, -10, 0, 30)
toggleBtn.Position = UDim2.new(0, 5, 0, 60)
toggleBtn.Text = "Start Fling"
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextSize = 16
toggleBtn.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -10, 0, 12)
statusLabel.Position = UDim2.new(0, 5, 0, 92)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Stopped"
statusLabel.TextSize = 10
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statusLabel.Parent = frame

-- Loop
local function startLoop()
    if isRunning then return end
    isRunning = true
    statusLabel.Text = "Running"
    task.spawn(function()
        while isRunning do
            local entry = userBox.Text
            local target, all = GetPlayerByName(entry)
            if all then
                for _, p in ipairs(Players:GetPlayers()) do
                    if p ~= LocalPlayer then SkidFling(p) end
                end
            elseif target then
                SkidFling(target)
            end
            task.wait(0.25)
        end
        statusLabel.Text = "Stopped"
    end)
end

local function stopLoop()
    isRunning = false
end

toggleBtn.MouseButton1Click:Connect(function()
    if not isRunning then
        startLoop()
        toggleBtn.Text = "Stop Fling"
    else
        stopLoop()
        toggleBtn.Text = "Start Fling"
    end
end)
